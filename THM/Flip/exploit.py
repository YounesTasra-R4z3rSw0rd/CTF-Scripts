from pwn import *
from colorama import Fore, Style

# User input 
print('')
ip = input('[' + Fore.BLUE + Style.BRIGHT + '*' + Style.NORMAL + Fore.WHITE + '] Enter the server\'s IP address: ').strip()

# Set up the connection
conn = remote(f'{ip}', 1337)        

username = b"bdmin&password=sUp3rPaSs1"
password = b"password"
password_prompt = b"bdmin&password=sUp3rPaSs1's password: "

# Sending the username 'bdmin&password=sUp3rPaSs1'
conn.sendlineafter(b'username: ', username)

# Sending a random password like 'password'
conn.sendlineafter(password_prompt, password)

# Receiving the leaked ciphertext and decoding it
leaked_ciphertext_line = conn.recvline(keepends=False)
leaked_ciphertext = leaked_ciphertext_line.decode("utf-8")
leaked_ciphertext = leaked_ciphertext.split(': ')[1].encode("utf-8")

print('[' + Style.BRIGHT + Fore.BLUE + '*' + Style.NORMAL + Fore.WHITE + '] Leaked ciphertext : ' + Style.BRIGHT + Fore.RED + leaked_ciphertext.decode("utf-8")[0:2] + Fore.WHITE + leaked_ciphertext.decode("utf-8")[2:] + Style.NORMAL)

# Flipping the first byte of the first block so that 'b' in the second block "bdmin&password=sUp3rPaSs1" becomes 'a' -> "admin&password=sUp3rPaSs1"
xor = ord('b') ^ ord('a')
flipped = hex(int(leaked_ciphertext[0:2], 16) ^ xor)[2:]
ciphertext = flipped.encode("utf-8") + leaked_ciphertext[2:]

print('[' + Style.BRIGHT + Fore.BLUE + '*' + Style.NORMAL + Fore.WHITE + '] Sending ciphertext: ' + Style.BRIGHT + Fore.GREEN + ciphertext.decode("utf-8")[0:2] + Fore.WHITE + ciphertext.decode("utf-8")[2:] + Style.NORMAL)

# Sending the resulting ciphertext (Leaked ciphertext with a flipped byte)
conn.sendlineafter(b'enter ciphertext: ', ciphertext)

# Receciving data from the server
resp = conn.recvuntil(b'}', drop=False)

# Printing the server's response
print('')
print('[' + Style.BRIGHT + Fore.GREEN + '+' + Style.NORMAL + Fore.WHITE + '] Server\'s response: ')
print('\t' + resp.decode('utf-8'))
print('')

# Close the connection
conn.close()

# ---------------------------- #
# Flipping process explained:  #
# ---------------------------- #

# Plaintext: 
# ----------

# access_username=bdmin&password=sUp3rPaSs1&password=password

# Plaintext partitioned into 16-bytes blocks: 
# ------------------------------------------

# access_username=  bdmin&password=s  Up3rPaSs1&passwo  rd=password   *****
# <-------------->  <-------------->  <-------------->  <----------><------->
#       16 bytes        16 bytes          16 bytes       11 bytes    5 bytes of padding

# Ciphertext:    
# -----------

# 9c651f10a3101007f6aa76db77ade76fdc856d39df31825284c5235983a9174b65a3e41f8f58183a31580bbbaac481b96eb6813e085b6b12d13c5c70b31561a9

# 9c651f10a3101007f6aa76db77ade76f dc856d39df31825284c5235983a9174b 65a3e41f8f58183a31580bbbaac481b9 6eb6813e085b6b12d13c5c70b31561a9
# <------------------------------> <------------------------------> <------------------------------> <------------------------------>
#            16 bytes                         16 bytes                          16 bytes                        16 bytes

# Bit Flipping on the first byte of the first ciphertext block:    
# -------------------------------------------------------------

        # Before Flipping: 9c 651f10a3101007f6aa76db77ade76fdc856d39df31825284c5235983a9174b65a3e41f8f58183a31580bbbaac481b96eb6813e085b6b12d13c5c70b31561a9
        # After Flipping : 9f 651f10a3101007f6aa76db77ade76fdc856d39df31825284c5235983a9174b65a3e41f8f58183a31580bbbaac481b96eb6813e085b6b12d13c5c70b31561a9

# Corresponding Plaintext:
# ------------------------

# access_username=admin&password=sUp3rPaSs1&password=password
